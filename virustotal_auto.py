import os

import virustotal_api as vt

from settings import *

def get_file_list ( root = MALWARES_PATHS ) :
    ret = []
    for path, dirs, files in os.walk(root) :
        for file in files :
            ret.append(os.path.join(path, file))
    return ret

def run():
    file_list = get_file_list()
    md5_list = [ os.path.splitext(os.path.basename(file))[0] for file in file_list ]
    key_cnt = len(API_KEY_LIST)
    while len(md5_list) != 0 :
        if not os.path.exists(REPORT_PATH):
            os.makedirs(REPORT_PATH)
        for i in range(len(md5_list)) :
            vt.retrieving_file_scan_report(md5_list[i], REPORT_PATH, API_KEY_LIST[i % key_cnt])
        json_list = os.listdir(REPORT_PATH)
        json_md5_list = [ os.path.splitext(json_path)[0] for json_path in json_list ]
        md5_list = list( set(md5_list) - set(json_md5_list) )

if __name__ == '__main__':
    run()
