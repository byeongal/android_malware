import subprocess, os
import fnmatch
import shutil
import multiprocessing as mp

from settings import *

def decom( args ) :
    md5, path, file = args
    command = "apktool.bat d -r -o \"{}\" \"{}\"".format(os.path.join(DECOMPILE_PATH, md5), os.path.join(path, file))
    try:
        subprocess.call(command, shell=True)
        shutil.rmtree(os.path.join(DECOMPILE_PATH, md5, 'res'))
        print("{} is done".format(md5))
    except:
        pass

def run() :
    vir_file_list = []
    for path, dirs, files in os.walk(MALWARES_PATHS) :
        for file in fnmatch.filter(files, '*.vir') :
            md5 = os.path.splitext(file)[0]
            if os.path.exists(os.path.join(DECOMPILE_PATH, md5)) :
                continue
            vir_file_list.append((md5, path, file))

    mp.freeze_support()

    with mp.Pool(os.cpu_count()) as pool :
        pool.map(decom, vir_file_list)

if __name__ == '__main__' :
    run()


