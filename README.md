# Android Malware Detection System

## 요약
스마트폰 사용자가 증가함에 따라 스마트폰 사용자를 노리는 악성코드 또한 증가하고 있다.
이에 따라 안드로이드 사용자를 노리는 악성코드 또 한 증가하는 추세이다. 현재 대부분의 안드로이드용 악성코드 탐지 프로그램이 사용하는 방법의 경우, 위변조 혹은 새 로운 악성코드에 대응이 어렵다는 문제가 존재한다. 이에 본 프로젝트에서는 딥러닝 기법을 이용해서 악성코드를 탐지하는 모델을 개발하는 것을 목표로 한다.

## 프로젝트 목적
스마트폰 사용자가 증가함에 따라 스마트폰 사용자를 노리는 악성코드 또한 증가하고 있다. G DATA 의 보안 블로그 자료를 보면 해마다 안드로이드 악성코드의 샘플이 증가하는 추세이다.

<div align="center">
<img src="https://file.gdatasoftware.com/_processed_/f/b/GDATA_Infographic_MWR_2017_ALL_New_malware_samples_years_EN_81097w1140h663.jpg" width="70%" height="70%">
</div>

이에 본 프로젝트는 악성으로 의심되는 안드로이드 앱(apk)파일을 정적 분석 기법을 이용해 특징(Feature)를 추출해 이를 ANN(Artificial Neural Network)기법을 이용해 악성인지 아닌지 탐지하는 딥러닝 모델을 제작하는 것을 목표로 한다.

## 팀 구성 및 역할 분담
* [신수철](http://github.com/hisfact)
  * [Virusshare](https://virusshare.com/) 에서 안드로이드 APK파일 다운로드
  * [VirusTotal](https://www.virustotal.com/)에서 리포트 요청 하는 스크립트 제작 및 딥러닝에 필요한 csv파일 제작
  * [APK Tool](https://ibotpeaches.github.io/Apktool/install/)을 이용한 apk파일 디컴파일 자동화
* [김영재](http://github.com/byeongal)
  * 디컴파일된 smali파일로 부터 딥러닝에 사용될 Feature Vector 제작
  * 딥러닝 모델 구성 및 학습

## 개발 환경
* Python 3.6.2
* Tensorflow 1.8

## 상세 역할
### 1. apk파일 수집
apk 파일은 [virusshare](https://virusshare.com/)에서 수집을 한다. virusshare VirusShare_Android_20130506.zip 파일과 VirusShare_Android_20140324.zip 파일을 배포를 하고 torrent를 통해서 배포를 하고 있으며, 총 35,397 개의 apk파일로 구성되어 있다.

<div align="center">
  <img src="https://i.imgur.com/PliXszz.png" width="70%" height="70%">
</div>

### 2. 라벨 제작
수집한 apk파일은 VirusTotal을 이용하여 [Bitdefender](https://www.bitdefender.com/)의 탐지 결과를 활용할 계획이다. Bitdefender를 사용하는 이유는 보안 인증 기관 [AV-TEST](https://www.av-test.org/en/)에서 2017년을 기준으로 [AV-TEST Best Android Security 2017 Award](https://www.av-test.org/en/award/2017/) 에 선정 되었기 때문이다. 바이러스 토탈에서는 제이슨(json)형태로 리포트 파일을 제공 하며 그 리포트 파일에서 원하는 악성코드의 탐지 결과를가져오기 위해 파싱하는 Python Script를 작성 하였다. 파싱한 결과를 통해 CSV(Comma Separated Values)파일로 만들어 딥러닝 학습 및 테스트에 사용 된다.

<div align="center">
  <img src="https://www.av-test.org/fileadmin/_processed_/5/9/csm_avtest_award_2017_best_android_security_bitdefender_ms_d9af1c6470.png" width="10%" height="10%">
</div>

### 3. 특징 추출
apk파일로 부터 학습에 사용될 특징을 추출하기 위해서는 먼저 APK Tool을 이용해서 파일을 디컴파일(Decompile)하였다. 디컴파일을 하게 되면 다음과 같이 파일이 나오게 되고 본 프로젝트에서는 smali폴더에 있는 smali파일을 사용한다. APK Tool을 자동화 하기 위해 Python 스크립트를 작성하여 자동화 하였다.
<div align="center">
  <img src="https://i.imgur.com/n5UFKSp.png" width="80%" height="80%">
</div>


### 4. 특징 가공
smali파일에서 [Dalvic Bytecode](https://source.android.com/devices/tech/dalvik/dalvik-bytecode)를 가져온 다음 [Feature Hashing](https://en.wikipedia.org/wiki/Feature_hashing)기법을 이용하여 Feature Vector를 제작 하였다. hash 함수로는 sha256을 사용했으며, 3, 4, 5 gram을 각각 4,096짜리 vector로 제작한 다음 [0, 1] 사이로 [Feature Scaling](https://en.wikipedia.org/wiki/Feature_scaling)을 하였다.

<div align="center">
  <img src="https://i.imgur.com/8y8JcAR.png" width="50%" height="50%">
</div>


### 5. 모델 설계 및 학습
딥러닝 모델은 ANN(Artificial Neural Network)를 이용할 것이다. ANN모델 설계를 위해서는 [Tensorflow](https://www.tensorflow.org/)를 이용 하였다. 심층 신경망의 입력 층 노드 개수는 12,288개이며, 2, 3, 4 – gram을 Feature Hashing 기법을 이용해 가공하였다. 심층 신경망의 은닉층 개수는 총 5개이며 각각 4096, 1024, 256, 64, 16개의 노드를 가지고, 활성화 함수로는 ReLU를 사용하였다. 또한 과적합을 막기 위해서 드랍 아웃 기법을 사용하였다. 제안하는 모델은 30%의 정보를 잊어버리도록 설정하였으며 마지막 은닉층을 거쳐 출력층에 도달할 때 소프트 맥스 함수를 이용하여 주어진 파일이 정상 또는 악성에 속할 확률로 변환한 뒤, 더 높은 확률을 선택하여 어떤 그룹에 속하는지 분류하였다. 학습에는 총 20,000개의 데이터를 사용 하였고, 테스트에는 학습에 사용되는 데이터가 아닌 1,028개의 데이터를 사용 하였다.

<div align="center">
  <img src="https://i.imgur.com/2yi6XGi.png" width="50%" height="50%">
</div>

## 실험 결과
| 그룹 | 갯수 | 정확도 |
|:----:|------|--------|
| 정상 | 277  | 77.98  |
| 악성 | 751  | 95.74  |
| 전체 | 1028 | 90.95  |
